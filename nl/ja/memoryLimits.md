---

copyright:
  years: 2015, 2018
lastupdated: "2018-06-27"

---

{:new_window: target="_blank"}
{:codeblock: .codeblock}

# メモリー制限および Liberty ビルドパック
{: #memory_limits}

Liberty ビルドパックでアプリケーションをデプロイするときには、メモリー限度を指定する必要があります。

## メモリー制限および Liberty ビルドパック
{: #memory_limits_and_liberty}


Liberty ビルドパックでアプリケーションをデプロイする際、
メモリー限度を指定するようプロンプトが出されます。 Liberty for Java ビルドパックでは、プロセスでメモリー制限を超えないようにするために、デフォルトのヒープ・メモリー・サイズ率を設定します。 また、環境変数 `JVM_ARGS` または `JBP_CONFIG_IBMJDK` を定義することで、ヒープ・メモリー・サイズまたはヒープ・メモリー率を指定することもできます。 詳しくは、[『ヒープ・メモリーのオプション』](#heap_memory_options)を参照してください。

指定するメモリー限度を決定するには、
Java アプリケーション・ヒープのサイズを指定するのではないことを理解することが重要です。 指定するのは、Diego コンテナーまたは DEA が使用できるメモリー量です。 この量には、以下のコンポーネントによって使用されるメモリーが含まれます。

* warden コンテナーによって使用されるメモリー。
* カーネル・エクステンションおよびシステム・ライブラリーをプロセスにマップするために使用されるメモリー。
* JVM 実行可能ファイル、JVM 作業ヒープ、jit スペース、および圧縮されたリファレンス用に使用されるメモリー。
* クラス (アプリケーション・サーバーおよびアプリケーション)、スレッド・スタック、および直接 IO バッファー用に使用されるメモリー。
* Java アプリケーション・ヒープによって使用されるメモリー。

JVM メモリー使用について詳しくは、developerWorks の記事[『Thanks for the memory, Linux』](http://www.ibm.com/developerworks/library/j-nativememory-linux/)を参照してください。

アプリケーションをデプロイすると、
プロセス全体のメモリー使用量がモニターされます。 メモリー使用量が、アプリケーションをデプロイしたときに指定したメモリー制限を超えると、
カーネルはプロセスを停止します。 この処置は警告なしで実行されますが、いくつかの方法で明示される可能性があります。

 アプリケーションのデプロイメント中にメモリー制限を超えた場合、障害が発生したことを知らせるメッセージを受け取り、以下のいずれかを確認できる場合があります。

  * 例えば、アプリケーションでフラッピングが起こっている場合があります。
  * アプリケーションが何度も開始しようとして、
いつも失敗に終わっているといった状況の場合もあります。
  * アプリケーション・デプロイメントが失敗したことを示すメッセージを受け取ることがあります。

アプリケーションがサービス中にメモリー制限を超えた場合、プロセスが停止し、Cloud Foundry はアプリケーションの再始動を試みます。 アプリケーションは再始動する可能性がありますが、一定期間は使用不可になります。

## ヒープ・メモリーのオプション
{: #heap_memory_options}

アプリケーションに割り振られるヒープ・メモリーの最大量をさまざまな方法でカスタマイズできます。例えば、`JVM_ARGS` 環境変数を使用する、`jvm.options` ファイルを変更する、あるいは `heap_size_ratio` を制御する `JBP_CONFIG_IBMJDK` 環境変数を設定するなどの方法があります。 いずれの設定も行わない場合、ビルドパックはデフォルト設定を使用します。

### ヒープ・メモリーのデフォルト
{: .#heap_memory_defaults}
メモリー制限を超えることによるエラーを防止するために、Liberty for Java ビルドパックでは、アプリケーションのデプロイ時に指定されたメモリー制限に応じてデフォルトのヒープ・サイズ率を設定します。

* メモリー制限が 512M 未満のアプリケーションは、ヒープ・サイズ率 50%
* メモリー制限が 512M 以上のアプリケーションは、ヒープ・サイズ率 75%

環境変数を使用してヒープ・メモリーを指定すると、デフォルトのヒープ・サイズ率をオーバーライドします。

### ヒープ・メモリーの指定
{: #specifying_heap_memory}

環境変数を使用するか、`jvm.options` ファイルを変更することによって、ヒープ・メモリー・サイズを設定できます。 環境変数 `JVM_ARGS` または `JBP_CONFIG_IBMJDK` を使用した場合は、アプリケーションを {{site.data.keyword.Bluemix_notm}} にプッシュしたときに変更が有効になります。 `jvm.options` ファイルを変更することで、ヒープ・サイズ構成への影響をローカルでテストすることもできます。

* `JVM_ARGS` 環境変数と -Xmx 引数を使用します。 例えば、最大ヒープ・サイズを 512 M に設定するには、以下のコマンドを使用し、その後でアプリケーションの再ステージングを行います。

```
    ibmcloud cf set-env myapp JVM_ARGS -Xmx512m
```
{: codeblock}

* JBP_CONFIG_IBMJDK 環境変数を使用してヒープ・サイズ率を指定します。  heap_size_ratio は、メモリー制限のうちどれだけの量をヒープに割り振るのかを指定する浮動小数点値です。  例えば、使用可能メモリーの半分 (50% すなわち 0.50) をヒープに割り振るには、以下のコマンドを発行して、アプリケーションを再ステージングします。

```
    ibmcloud cf set-env myapp JBP_CONFIG_IBMJDK "heap_size_ratio: 0.50"
```
{: codeblock}

* アプリケーションが[サーバー・ディレクトリー](optionsForPushing.html#server_directory)または[パッケージされたサーバー](optionsForPushing.html#packaged_server)である場合、jvm.options ファイルに -Xmx 引数を指定します。 Liberty ランタイムでの `jvm.options` ファイルの使用について詳しくは、[Setting generic JVM](http://www-01.ibm.com/support/docview.wss?uid=swg21596474) を参照してください。  
